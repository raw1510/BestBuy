<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Affiliate Product Showcase</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .star-rating {
      color: #fbbf24;
    }
    .image-container {
      position: relative;
      background-color: #f3f4f6;
    }
    .image-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f3f4f6;
    }
    .fade-in {
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
    .fade-in.loaded {
      opacity: 1;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- 
    Code Walkthrough:
    1. Infinite Scroll: Uses IntersectionObserver to detect when user scrolls near bottom
    2. Search: Filters products client-side with 300ms debounce
    3. Lazy Loading: Images load only when they enter viewport
    4. Pagination: Loads 20 products per page from filtered results
    5. Remote Data: Fetches product data from external JSON URL
    6. Image Handling: Direct Amazon URLs with fallback placeholder
  -->

  <header class="bg-white shadow-sm">
    <div class="container mx-auto px-4 py-4 flex items-center">
      <!-- Logo placeholder -->
      <svg class="w-8 h-8 text-blue-600 mr-2" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
      </svg>
      <h1 class="text-xl font-bold text-gray-800">Affiliate Showcase</h1>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <!-- Hero Section -->
    <section class="text-center mb-12">
      <h2 class="text-3xl font-bold text-gray-900 mb-2">Discover Amazing Products</h2>
      <p class="text-gray-600 mb-6">Handpicked items you'll love</p>
      <p class="text-sm text-gray-500">We may earn a commission from products purchased through affiliate links.</p>
    </section>

    <!-- Search Bar -->
    <div class="mb-12 max-w-2xl mx-auto">
      <input 
        type="text" 
        id="searchInput"
        placeholder="Search products..."
        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
      >
      <div aria-live="polite" id="resultCount" class="mt-2 text-sm text-gray-600 text-center"></div>
    </div>

    <!-- Product Grid -->
    <div id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
      <!-- Product cards will be inserted here by JavaScript -->
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="hidden text-center py-8">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
    </div>

    <!-- End of Results Message -->
    <div id="endMessage" class="hidden text-center py-8 text-gray-500">
      <p>You've reached the end of the products</p>
    </div>

    <!-- No Results Message -->
    <div id="noResults" class="hidden text-center py-8 text-gray-500">
      <p>No products found. Try a different search term.</p>
    </div>
  </main>

  <!-- Footer Disclosure -->
  <footer class="bg-white border-t py-6 mt-12">
    <div class="container mx-auto px-4 text-center text-sm text-gray-500">
      <p>We may earn a commission from products purchased through affiliate links.</p>
      <p class="mt-2">As an Amazon Associate I earn from qualifying purchases.</p>
    </div>
  </footer>

  <script>
    // Configuration
    const PRODUCTS_PER_PAGE = 20; // Change page size here
    const DEBOUNCE_DELAY = 300; // Search debounce in ms
    const AFFILIATE_TAG = 'YOUR_AFFILIATE_TAG'; // Insert your affiliate tag here
    const JSON_URL = 'https://raw1510.github.io/BestBuy/products.json'; // Your GitHub JSON URL

    // State management
    let allProducts = [];
    let currentPage = 1;
    let isLoading = false;
    let filteredProducts = [];
    let searchQuery = '';

    // DOM Elements
    const productGrid = document.getElementById('productGrid');
    const searchInput = document.getElementById('searchInput');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const endMessage = document.getElementById('endMessage');
    const noResults = document.getElementById('noResults');
    const resultCount = document.getElementById('resultCount');

    // Initialize the application
    document.addEventListener('DOMContentLoaded', async () => {
      await loadProducts();
      setupInfiniteScroll();
      setupSearch();
      loadProductsPage(); // Load initial page
    });

    // Load products from remote JSON
    async function loadProducts() {
      try {
        loadingIndicator.classList.remove('hidden');
        const response = await fetch(JSON_URL);
        if (!response.ok) throw new Error('Failed to fetch products');
        allProducts = await response.json();
        filteredProducts = [...allProducts];
        updateResultCount();
        console.log(`Loaded ${allProducts.length} products successfully`);
      } catch (error) {
        console.error('Error loading products:', error);
        // Show error message to user
        productGrid.innerHTML = `
          <div class="col-span-full text-center py-12">
            <p class="text-red-500">Failed to load products. Please try again later.</p>
            <p class="text-sm text-gray-500 mt-2">Error: ${error.message}</p>
          </div>
        `;
      } finally {
        loadingIndicator.classList.add('hidden');
      }
    }

    // Set up infinite scroll
    function setupInfiniteScroll() {
      const observer = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting && !isLoading) {
          loadProductsPage();
        }
      }, {
        rootMargin: '100px' // Trigger 100px before reaching bottom
      });

      observer.observe(document.querySelector('footer'));
    }

    // Set up search with debounce
    function setupSearch() {
      let searchTimeout;
      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          performSearch();
        }, DEBOUNCE_DELAY);
      });
    }

    // Perform search on products
    function performSearch() {
      searchQuery = searchInput.value.toLowerCase().trim();
      
      if (searchQuery === '') {
        filteredProducts = [...allProducts];
      } else {
        filteredProducts = allProducts.filter(product => 
          product.title.toLowerCase().includes(searchQuery) || 
          product.description.toLowerCase().includes(searchQuery)
        );
      }
      
      // Reset pagination
      currentPage = 1;
      productGrid.innerHTML = '';
      updateResultCount();
      
      // Load first page of filtered results
      loadProductsPage();
      
      // Show/hide no results message
      if (filteredProducts.length === 0) {
        noResults.classList.remove('hidden');
      } else {
        noResults.classList.add('hidden');
      }
    }

    // Update result count for screen readers
    function updateResultCount() {
      const count = filteredProducts.length;
      resultCount.textContent = count > 0 
        ? `Showing ${count} product${count !== 1 ? 's' : ''}` 
        : '';
    }

    // Load a page of products
    function loadProductsPage() {
      if (isLoading || filteredProducts.length === 0) return;
      
      isLoading = true;
      loadingIndicator.classList.remove('hidden');
      endMessage.classList.add('hidden');
      
      // Calculate pagination
      const startIndex = (currentPage - 1) * PRODUCTS_PER_PAGE;
      const endIndex = startIndex + PRODUCTS_PER_PAGE;
      const pageProducts = filteredProducts.slice(startIndex, endIndex);
      
      // Check if we've reached the end
      if (pageProducts.length === 0) {
        loadingIndicator.classList.add('hidden');
        if (filteredProducts.length > 0) {
          endMessage.classList.remove('hidden');
        }
        isLoading = false;
        return;
      }
      
      // Create product cards
      const fragment = document.createDocumentFragment();
      pageProducts.forEach(product => {
        const card = createProductCard(product);
        fragment.appendChild(card);
      });
      
      // Add to DOM
      productGrid.appendChild(fragment);
      
      // Set up lazy loading for images
      setupImageLazyLoading();
      
      // Update state
      currentPage++;
      loadingIndicator.classList.add('hidden');
      isLoading = false;
    }

    // Process image URL - improved handling for Amazon URLs
    function processImageUrl(url) {
      if (!url) return '';
      
      // Clean the URL
      let cleanUrl = url.trim();
      
      // If it's an Amazon image URL, we can use it directly
      // Amazon allows hotlinking for their product images
      if (cleanUrl.includes('amazon.com') || cleanUrl.includes('ssl-images-amazon.com') || cleanUrl.includes('m.media-amazon.com')) {
        return cleanUrl;
      }
      
      // For other URLs, return as-is
      return cleanUrl;
    }

    // Create fallback image placeholder
    function createImagePlaceholder() {
      return `
        <div class="image-placeholder">
          <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
        </div>
      `;
    }

    // Create a product card element
    function createProductCard(product) {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-300';
      
      // Truncate description to 100 characters
      const truncatedDescription = product.description && product.description.length > 100 
        ? product.description.substring(0, 100) + '...' 
        : (product.description || 'No description available');
      
      // Create star rating
      const rating = parseFloat(product.rating) || 0;
      const fullStars = Math.floor(rating);
      const hasHalfStar = rating % 1 >= 0.5;
      let starsHTML = '';
      
      for (let i = 0; i < 5; i++) {
        if (i < fullStars) {
          starsHTML += '<span class="star-rating">★</span>';
        } else if (i === fullStars && hasHalfStar) {
          starsHTML += '<span class="star-rating">★</span>';
        } else {
          starsHTML += '<span class="text-gray-300">★</span>';
        }
      }
      
      // Process image URL
      const imageUrl = processImageUrl(product.image);
      const hasImage = imageUrl && imageUrl.length > 0;
      
      card.innerHTML = `
        <div class="relative pb-[100%] image-container"> <!-- Square container for image -->
          ${hasImage ? `
            <img 
              data-src="${imageUrl}" 
              alt="${product.title || 'Product image'}"
              class="absolute inset-0 w-full h-full object-cover lazy fade-in"
              loading="lazy"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
            >
            <div class="image-placeholder" style="display: none;">
              <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
            </div>
          ` : createImagePlaceholder()}
          <div class="absolute inset-0 bg-gray-200 skeleton" id="skeleton-${product.id || Math.random()}"></div>
        </div>
        <div class="p-4">
          <h3 class="font-semibold text-gray-900 mb-1 line-clamp-2 h-12">${product.title || 'Untitled Product'}</h3>
          <div class="flex items-center mb-2">
            <div class="flex mr-2">
              ${starsHTML}
            </div>
            <span class="text-sm text-gray-600">${rating.toFixed(1)}</span>
          </div>
          <p class="text-gray-600 text-sm mb-3 line-clamp-2 h-10">${truncatedDescription}</p>
          <div class="flex justify-between items-center">
            <span class="font-bold text-gray-900">${product.price || 'Price not available'}</span>
            <a 
              href="${(product.affiliate_url || '').trim()}" 
              target="_blank" 
              rel="noopener sponsored"
              class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors duration-200"
              ${!product.affiliate_url ? 'onclick="event.preventDefault(); alert(\'Product link not available\');"' : ''}
            >
              View on Amazon
            </a>
          </div>
        </div>
      `;
      
      return card;
    }

    // Set up lazy loading for images
    function setupImageLazyLoading() {
      const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            const skeleton = img.parentElement.querySelector('.skeleton');
            
            img.src = img.dataset.src;
            
            img.onload = () => {
              img.classList.add('loaded');
              if (skeleton) skeleton.remove();
              observer.unobserve(img);
            };
            
            img.onerror = () => {
              console.log('Image failed to load:', img.dataset.src);
              if (skeleton) skeleton.remove();
              observer.unobserve(img);
            };
          }
        });
      }, {
        rootMargin: '50px'
      });
      
      // Observe all new lazy images
      document.querySelectorAll('img[data-src]:not([src])').forEach(img => {
        imageObserver.observe(img);
      });
    }
  </script>
</body>
</html>
